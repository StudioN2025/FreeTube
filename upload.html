<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ - FreeTube</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* –°—Ç–∏–ª–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ */
    </style>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
        const SUPABASE_CONFIG = {
            url: 'https://zsjxcrjopoxoaavmnoef.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzanhjcmpvcG94b2Fhdm1ub2VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTcyMTMsImV4cCI6MjA4Nzg3MzIxM30.MV8W9SAO3lvjLoqlQOLuGjIf3Ipa-OTJDNYVzs9Rfkc'
        };

        if (typeof supabase === 'undefined') {
            console.error('‚ùå Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
            throw new Error('Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }

        const supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - –í–û–¢ –°–Æ–î–ê –ù–£–ñ–ù–û –í–°–¢–ê–í–õ–Ø–¢–¨!
        const supabaseHelpers = {
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–∏–¥–µ–æ
            async getVideos(filter = 'all', limit = 50) {
                try {
                    let query = supabaseClient
                        .from('videos')
                        .select('*');
                    
                    switch(filter) {
                        case 'latest':
                            query = query.order('created_at', { ascending: false });
                            break;
                        case 'popular':
                            query = query.order('views', { ascending: false });
                            break;
                        default:
                            query = query.order('created_at', { ascending: false });
                    }
                    
                    const { data, error } = await query.limit(limit);
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                    return { data: null, error };
                }
            },

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ –ø–æ ID
            async getVideoById(videoId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('*')
                        .eq('id', videoId)
                        .single();
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                    return { data: null, error };
                }
            },

            // –í–û–¢ –ó–î–ï–°–¨ - —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ
            async createVideo(videoData) {
                try {
                    console.log('–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ —Å –¥–∞–Ω–Ω—ã–º–∏:', videoData);
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .insert([{
                            title: videoData.title,
                            description: videoData.description,
                            duration: videoData.duration,
                            channel_name: videoData.channel_name,
                            user_id: videoData.user_id,
                            thumbnail: videoData.thumbnail,
                            total_chunks: videoData.total_chunks,
                            status: 'uploading'
                        }])
                        .select();
                    
                    if (error) {
                        console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error);
                        throw error;
                    }
                    
                    console.log('–í–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ:', data);
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                    return { data: null, error };
                }
            },

            // –í–û–¢ –ó–î–ï–°–¨ - —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞–Ω–∫–∞ (saveChunk)
            async saveChunk(videoId, chunkIndex, chunkData) {
                try {
                    console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞–Ω–∫–∞ ${chunkIndex} –¥–ª—è –≤–∏–¥–µ–æ ${videoId}`);
                    const { data, error } = await supabaseClient
                        .from('video_chunks')
                        .insert([{
                            video_id: videoId,
                            chunk_index: chunkIndex,
                            chunk_data: chunkData
                        }]);
                    
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞–Ω–∫–∞:', error);
                        throw error;
                    }
                    
                    console.log(`–ß–∞–Ω–∫ ${chunkIndex} —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ`);
                    return { success: true, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞–Ω–∫–∞:', error);
                    return { success: false, error };
                }
            },

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            async completeUpload(videoId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .update({ status: 'completed' })
                        .eq('id', videoId);
                    
                    if (error) throw error;
                    return { success: true, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    return { success: false, error };
                }
            },

            // –ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ
            async searchVideos(searchTerm) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('*')
                        .ilike('title', `%${searchTerm}%`)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                    return { data: null, error };
                }
            },

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            async getRecommendedVideos(currentVideoId, limit = 10) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('*')
                        .neq('id', currentVideoId)
                        .order('views', { ascending: false })
                        .limit(limit);
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', error);
                    return { data: null, error };
                }
            },

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            getCurrentUser() {
                return supabaseClient.auth.getUser();
            },

            // –í—ã—Ö–æ–¥
            async signOut() {
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    return { success: true, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                    return { success: false, error };
                }
            },

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            async testConnection() {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error) throw error;
                    console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    return true;
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Supabase:', error.message);
                    return false;
                }
            }
        };

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.supabaseClient = supabaseClient;
        window.supabaseHelpers = supabaseHelpers;

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        window.logout = async function() {
            try {
                await supabaseHelpers.signOut();
                localStorage.removeItem('user');
                alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
            }
        };

        // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        supabaseHelpers.testConnection();
        console.log('üöÄ FreeTube Upload –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    </script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-left">
                <a href="/" class="logo">FreeTube</a>
            </div>
            <div class="nav-right" id="navRight"></div>
        </nav>
    </header>

    <main class="upload-container">
        <h1>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h1>
        
        <div class="quality-info">
            <strong>üì¶ –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:</strong> –í–∏–¥–µ–æ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —á–∞–Ω–∫–∏ –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ —á–∞—Å—Ç—è–º
        </div>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="videoInput" accept="video/*" hidden>
            <div class="upload-content">
                <div class="upload-icon">üìπ</div>
                <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                <small>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 200 –ú–ë</small>
                <div class="format-info">
                    <i>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, WebM, OGG, MOV</i>
                </div>
                <div class="file-size-warning" id="fileSizeWarning"></div>
            </div>
        </div>

        <div class="video-preview" id="videoPreview" style="display: none;">
            <video controls></video>
            <div class="file-size-warning" id="previewSizeWarning"></div>
            <div class="chunk-info" id="chunkInfo"></div>
        </div>

        <form id="uploadForm" style="display: none;">
            <div class="form-group">
                <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ</label>
                <input type="text" id="title" required maxlength="100" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ">
            </div>

            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" rows="4" maxlength="5000" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ"></textarea>
            </div>

            <button type="submit" class="submit-btn" id="uploadBtn">
                <span class="btn-text">–ù–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É</span>
                <span class="loading-spinner" style="display: none;"></span>
            </button>
        </form>

        <div class="progress-bar" style="display: none;">
            <div class="progress-fill"></div>
            <span class="progress-text">0%</span>
        </div>
    </main>

    <script src="js/upload-chunks.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const navRight = document.getElementById('navRight');
            
            try {
                const { data: { user } } = await supabaseHelpers.getCurrentUser();
                
                if (user) {
                    const email = user.email || 'User';
                    const initial = email.charAt(0).toUpperCase();
                    
                    navRight.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar">${initial}</div>
                            <span>${email}</span>
                            <button id="logoutBtn" onclick="logout()">–í—ã–π—Ç–∏</button>
                        </div>
                    `;
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
