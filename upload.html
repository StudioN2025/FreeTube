<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ - FreeTube</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º CSS -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            background: white;
        }

        .upload-area:hover {
            border-color: #ff0000;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .video-preview video {
            width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff0000;
            box-shadow: 0 0 0 2px rgba(255,0,0,0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            background-color: #ff0000;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #cc0000;
        }

        .submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .progress-bar {
            margin-top: 1rem;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: #ff0000;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-weight: 600;
            text-shadow: 0 0 5px white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ff0000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        #logoutBtn {
            padding: 0.5rem 1rem;
            background-color: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            color: #333;
            transition: all 0.3s;
        }

        #logoutBtn:hover {
            background-color: #ff0000;
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            color: white;
            border-radius: 8px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .notification.success {
            background-color: #4caf50;
        }

        .notification.error {
            background-color: #ff4444;
        }

        .notification.info {
            background-color: #2196f3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .format-info {
            margin-top: 10px;
            color: #666;
            font-size: 12px;
        }

        .format-info i {
            color: #ff0000;
        }

        .file-size-warning {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 500;
        }

        .quality-info {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid #ff0000;
        }

        .quality-info strong {
            color: #ff0000;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff0000;
            text-decoration: none;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        small {
            color: #666;
            display: block;
            margin-top: 5px;
        }
    </style>
    
    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase -->
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        const SUPABASE_CONFIG = {
            url: 'https://zsjxcrjopoxoaavmnoef.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzanhjcmpvcG94b2Fhdm1ub2VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTcyMTMsImV4cCI6MjA4Nzg3MzIxM30.MV8W9SAO3lvjLoqlQOLuGjIf3Ipa-OTJDNYVzs9Rfkc'
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ Supabase SDK
        if (typeof supabase === 'undefined') {
            console.error('‚ùå Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
            throw new Error('Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏
        const supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true
            },
            global: {
                headers: { 'X-Client-Info': 'freetube' },
                fetch: (url, options) => {
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 10 –º–∏–Ω—É—Ç
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 600000); // 10 –º–∏–Ω—É—Ç
                    
                    return fetch(url, {
                        ...options,
                        signal: controller.signal
                    }).finally(() => clearTimeout(timeoutId));
                }
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        const supabaseHelpers = {
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–∏–¥–µ–æ
            async getVideos(filter = 'all', limit = 50) {
                try {
                    let query = supabaseClient
                        .from('videos')
                        .select('*');
                    
                    switch(filter) {
                        case 'latest':
                            query = query.order('created_at', { ascending: false });
                            break;
                        case 'popular':
                            query = query.order('views', { ascending: false });
                            break;
                        default:
                            query = query.order('created_at', { ascending: false });
                    }
                    
                    const { data, error } = await query.limit(limit);
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                    return { data: null, error };
                }
            },

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ –ø–æ ID
            async getVideoById(videoId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('*')
                        .eq('id', videoId)
                        .single();
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                    return { data: null, error };
                }
            },

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ RPC —Ñ—É–Ω–∫—Ü–∏—é —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
            async insertVideo(videoData) {
                try {
                    const { data, error } = await supabaseClient
                        .rpc('insert_video', {
                            p_title: videoData.title,
                            p_description: videoData.description,
                            p_video_data: videoData.video_data,
                            p_thumbnail: videoData.thumbnail,
                            p_duration: videoData.duration,
                            p_channel_name: videoData.channel_name,
                            p_user_id: videoData.user_id
                        });
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≤–∏–¥–µ–æ:', error);
                    return { data: null, error };
                }
            },

            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            async incrementViews(videoId) {
                try {
                    const { error } = await supabaseClient.rpc('increment_views', { 
                        video_id: videoId 
                    });
                    
                    if (error) throw error;
                    return { success: true, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:', error);
                    return { success: false, error };
                }
            },

            // –ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ
            async searchVideos(searchTerm) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('*')
                        .ilike('title', `%${searchTerm}%`)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                    return { data: null, error };
                }
            },

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            async getRecommendedVideos(currentVideoId, limit = 10) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('*')
                        .neq('id', currentVideoId)
                        .order('views', { ascending: false })
                        .limit(limit);
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', error);
                    return { data: null, error };
                }
            },

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            getCurrentUser() {
                return supabaseClient.auth.getUser();
            },

            // –í—ã—Ö–æ–¥
            async signOut() {
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    return { success: true, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                    return { success: false, error };
                }
            },

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            async testConnection() {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error) throw error;
                    console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    return true;
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Supabase:', error.message);
                    return false;
                }
            }
        };

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.supabaseClient = supabaseClient;
        window.supabaseHelpers = supabaseHelpers;

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        window.logout = async function() {
            try {
                await supabaseHelpers.signOut();
                localStorage.removeItem('user');
                alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
            }
        };

        // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        supabaseHelpers.testConnection();
        console.log('üöÄ FreeTube Upload –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    </script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-left">
                <a href="/" class="logo">FreeTube</a>
            </div>
            <div class="nav-right" id="navRight">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </nav>
    </header>

    <main class="upload-container">
        <h1>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h1>
        
        <div class="quality-info">
            <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ: <strong>50 –ú–ë</strong> (–∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Base64)
        </div>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="videoInput" accept="video/*" hidden>
            <div class="upload-content">
                <div class="upload-icon">üìπ</div>
                <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                <small>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë</small>
                <div class="format-info">
                    <i>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, WebM, OGG, MOV</i>
                </div>
                <div class="file-size-warning" id="fileSizeWarning"></div>
            </div>
        </div>

        <div class="video-preview" id="videoPreview" style="display: none;">
            <video controls></video>
            <div class="file-size-warning" id="previewSizeWarning"></div>
        </div>

        <form id="uploadForm" style="display: none;">
            <div class="form-group">
                <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ</label>
                <input type="text" id="title" required maxlength="100" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ">
            </div>

            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" rows="4" maxlength="5000" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ"></textarea>
            </div>

            <div class="form-group">
                <label for="quality">–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ</label>
                <select id="quality">
                    <option value="high">HD (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                    <option value="medium">–°—Ä–µ–¥–Ω–µ–µ</option>
                    <option value="low">–ù–∏–∑–∫–æ–µ</option>
                </select>
            </div>

            <button type="submit" class="submit-btn" id="uploadBtn">
                <span class="btn-text">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ</span>
                <span class="loading-spinner" style="display: none;"></span>
            </button>
        </form>

        <div class="progress-bar" style="display: none;">
            <div class="progress-fill"></div>
            <span class="progress-text">0%</span>
        </div>
    </main>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º upload.js -->
    <script src="js/upload.js"></script>
    
    <script>
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            const navRight = document.getElementById('navRight');
            
            try {
                const { data: { user } } = await supabaseHelpers.getCurrentUser();
                
                if (user) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    const email = user.email || 'User';
                    const initial = email.charAt(0).toUpperCase();
                    
                    navRight.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar">${initial}</div>
                            <span>${email}</span>
                            <button id="logoutBtn" onclick="logout()">–í—ã–π—Ç–∏</button>
                        </div>
                    `;
                } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ login
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
