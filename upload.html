<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ - FreeTube</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* –í–∞—à–∏ —Å—Ç–∏–ª–∏ */
        .upload-container { max-width: 800px; margin: 2rem auto; padding: 2rem; }
        .upload-area { border: 2px dashed #ccc; border-radius: 8px; padding: 3rem; text-align: center; cursor: pointer; transition: border-color 0.3s; background: white; }
        .upload-area:hover { border-color: #ff0000; }
        .upload-icon { font-size: 4rem; margin-bottom: 1rem; }
        .video-preview video { width: 100%; max-height: 400px; border-radius: 8px; margin: 1rem 0; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; }
        .submit-btn { width: 100%; padding: 1rem; background-color: #ff0000; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; }
        .submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .progress-bar { margin-top: 1rem; height: 30px; background-color: #f0f0f0; border-radius: 15px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background-color: #ff0000; width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #333; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: #ff0000; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        #logoutBtn { padding: 0.5rem 1rem; background-color: #f0f0f0; border: none; border-radius: 20px; cursor: pointer; }
        #logoutBtn:hover { background-color: #ff0000; color: white; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; color: white; border-radius: 8px; z-index: 9999; animation: slideIn 0.3s ease; }
        .notification.success { background-color: #4caf50; }
        .notification.error { background-color: #ff4444; }
        .notification.info { background-color: #2196f3; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .format-info { margin-top: 10px; color: #666; font-size: 12px; }
        .file-size-warning { color: #ff4444; font-size: 12px; margin-top: 5px; }
        .chunk-info { margin-top: 10px; color: #4caf50; font-size: 12px; }
    </style>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
        const SUPABASE_CONFIG = {
            url: 'https://zsjxcrjopoxoaavmnoef.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzanhjcmpvcG94b2Fhdm1ub2VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTcyMTMsImV4cCI6MjA4Nzg3MzIxM30.MV8W9SAO3lvjLoqlQOLuGjIf3Ipa-OTJDNYVzs9Rfkc'
        };

        if (typeof supabase === 'undefined') {
            console.error('‚ùå Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
            throw new Error('Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }

        const supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        const supabaseHelpers = {
            // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –≤–∏–¥–µ–æ
            async createVideo(videoData) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .insert([{
                            title: videoData.title,
                            description: videoData.description,
                            duration: videoData.duration,
                            channel_name: videoData.channel_name,
                            user_id: videoData.user_id,
                            thumbnail: videoData.thumbnail,
                            total_chunks: videoData.total_chunks,
                            status: 'uploading'
                        }])
                        .select();
                    
                    if (error) throw error;
                    return { data, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                    return { data: null, error };
                }
            },

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞–Ω–∫–∞
            async saveChunk(videoId, chunkIndex, chunkData) {
                try {
                    const { data, error } = await supabaseClient
                        .from('video_chunks')
                        .insert([{
                            video_id: videoId,
                            chunk_index: chunkIndex,
                            chunk_data: chunkData
                        }]);
                    
                    if (error) throw error;
                    return { success: true, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞–Ω–∫–∞:', error);
                    return { success: false, error };
                }
            },

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            async completeUpload(videoId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .update({ status: 'completed' })
                        .eq('id', videoId);
                    
                    if (error) throw error;
                    return { success: true, error: null };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    return { success: false, error };
                }
            },

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            getCurrentUser() {
                return supabaseClient.auth.getUser();
            },

            async signOut() {
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    return { success: true, error: null };
                } catch (error) {
                    return { success: false, error };
                }
            },

            async testConnection() {
                try {
                    const { data, error } = await supabaseClient
                        .from('videos')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error) throw error;
                    console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    return true;
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Supabase:', error.message);
                    return false;
                }
            }
        };

        window.supabaseClient = supabaseClient;
        window.supabaseHelpers = supabaseHelpers;

        window.logout = async function() {
            try {
                await supabaseHelpers.signOut();
                localStorage.removeItem('user');
                alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
            }
        };

        supabaseHelpers.testConnection();
        console.log('üöÄ FreeTube Upload –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    </script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-left">
                <a href="/" class="logo">FreeTube</a>
            </div>
            <div class="nav-right" id="navRight"></div>
        </nav>
    </header>

    <main class="upload-container">
        <h1>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h1>
        
        <div class="quality-info">
            <strong>üì¶ –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:</strong> –í–∏–¥–µ–æ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —á–∞–Ω–∫–∏ –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ —á–∞—Å—Ç—è–º
        </div>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="videoInput" accept="video/*" hidden>
            <div class="upload-content">
                <div class="upload-icon">üìπ</div>
                <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                <small>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 200 –ú–ë</small>
                <div class="format-info">
                    <i>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, WebM, OGG, MOV</i>
                </div>
                <div class="file-size-warning" id="fileSizeWarning"></div>
            </div>
        </div>

        <div class="video-preview" id="videoPreview" style="display: none;">
            <video controls></video>
            <div class="file-size-warning" id="previewSizeWarning"></div>
            <div class="chunk-info" id="chunkInfo"></div>
        </div>

        <form id="uploadForm" style="display: none;">
            <div class="form-group">
                <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ</label>
                <input type="text" id="title" required maxlength="100" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ">
            </div>

            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" rows="4" maxlength="5000" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ"></textarea>
            </div>

            <button type="submit" class="submit-btn" id="uploadBtn">
                <span class="btn-text">–ù–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É</span>
                <span class="loading-spinner" style="display: none;"></span>
            </button>
        </form>

        <div class="progress-bar" style="display: none;">
            <div class="progress-fill"></div>
            <span class="progress-text">0%</span>
        </div>
    </main>

    <script src="js/upload-chunks.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const navRight = document.getElementById('navRight');
            
            try {
                const { data: { user } } = await supabaseHelpers.getCurrentUser();
                
                if (user) {
                    const email = user.email || 'User';
                    const initial = email.charAt(0).toUpperCase();
                    
                    navRight.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar">${initial}</div>
                            <span>${email}</span>
                            <button id="logoutBtn" onclick="logout()">–í—ã–π—Ç–∏</button>
                        </div>
                    `;
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
